---
title: "Traffic interrompu !"
output:
  html_document:
    self_contained: false
    css: styles.css
---


<script>
d3.timeFormatDefaultLocale({
   "dateTime":[
      "%A, le %e %B %Y, %X"
   ],
   "date":[
      "%d/%m/%Y"
   ],
   "time":[
      "%H:%M:%S"
   ],
   "periods":[
      "AM",
      "PM"
   ],
   "days":[
      "dimanche",
      "lundi",
      "mardi",
      "mercredi",
      "jeudi",
      "vendredi",
      "samedi"
   ],
   "shortDays":[
      "dim.",
      "lun.",
      "mar.",
      "mer.",
      "jeu.",
      "ven.",
      "sam."
   ],
   "months":[
      "janvier",
      "février",
      "mars",
      "avril",
      "mai",
      "juin",
      "juillet",
      "août",
      "septembre",
      "octobre",
      "novembre",
      "décembre"
   ],
   "shortMonths":[
      "janv.",
      "févr.",
      "mars",
      "avr.",
      "mai",
      "juin",
      "juil.",
      "août",
      "sept.",
      "oct.",
      "nov.",
      "déc."
   ]
});
</script>




```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)


# PACKAGES
library("data.table")
library("stringr")
library("lubridate")
library("billboarder")
library("htmltools")
library("shiny")


# DATAS
m_incidents <- readRDS("m_incidents.rds")
# m_incidents <- m_incidents[year(date) >= 2018]


r_incidents <- readRDS("r_incidents.rds")
# m_incidents <- m_incidents[year(date) >= 2018]


t_incidents <- readRDS("t_incidents.rds")
# m_incidents <- m_incidents[year(date) >= 2018]



# FUNS
make_chart <- function(data, line, type = "metro") {
  line_id <- switch(
    type,
    "metro" = sprintf("Ligne%d_RATP", line),
    "rer" = line,
    "transilien" = line
  )
  max_y <- max(data$value)
  data <- copy(data)
  data <- data[screen_name == line_id, list(x = date, variable = variable, value = value)]
  data <- dcast(data = data, formula = x ~ variable, value.var = "value")
  billboarder(height = "250px") %>% 
    # bb_aes(x = x, y = value, group = variable) %>% 
    bb_linechart(data = data[, list(x, interrompu, perturbe)], type = "area-step") %>% 
    bb_data(
      order = NULL,
      groups = list(as.list(c("perturbe", "interrompu"))),
      names = list("perturbe" = "Perturbé", "interrompu" = "Interrompu")
    ) %>% 
    bb_y_axis(
      max = max_y, 
      tick = list(values = head(scales::pretty_breaks()(c(0, max_y)), n = -1))
    ) %>% 
    bb_x_axis(tick = list(fit = FALSE, format = "%b")) %>% 
    bb_y_grid(show = TRUE) %>% 
    bb_legend(show = FALSE) %>% 
    bb_colors_manual(interrompu = "#FA5858", perturbe = "#F7D358") %>% 
    bb_tooltip(
      order = "",
      linked = list(name = "metro-tooltip"), 
      format = list(
        title = htmlwidgets::JS(
          paste0("function(x) {", 
                 "var format = d3.timeFormat('%d %B'); return 'Semaine du ' + format(x); }")
        )
      ),
    position = htmlwidgets::JS(
      "function(data, width, height, element) {return {top: -25, right: 100};}"
    )
  ) %>% 
  bb_add_style(".bb-tooltip-container" = "right: 10px; ", ".bb-tooltip th" = "background-color: #337ab7;")
}

# nombre incidents
n_inci <- function(data, line, incident = "perturbe", type = "metro") {
  line_id <- switch(
    type,
    "metro" = sprintf("Ligne%d_RATP", line),
    "rer" = line,
    "transilien" = line
  )
  data[screen_name == line_id & variable == incident, sum(value)]
}
```


<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.2.0/css/all.css" integrity="sha384-hWVjflwFxL6sNzntih27bfxkr27PmbbK/iSvJ+a4+0owXq79v+lsFkW54bOGbiDQ" crossorigin="anonymous">
<span class="main-icon">
<i class="fa fa-train" aria-hidden="true"></i>
</span>

</br>
Nombre de tweets par semaine indiquant &laquo; traffic perturbé &raquo; ou &laquo; traffic interrompu &raquo; sur les comptes des lignes de transport d'Île-de-France (Métro, RER et Transilien), sur la période du `r format(m_incidents[, min(date)], "%d/%m/%Y")` au `r format(m_incidents[, max(date)], "%d/%m/%Y")`.
</br>


Retrouvez le code sur notre&nbsp; <i class="fab fa-github" aria-hidden="true"></i> GitHub : https://github.com/dreamRs/tweets-transports


</br>


## Cliquez pour changer d'onglet : {.tabset .tabset-pills .tabset-justified .nav-justified}

### <img src="www/Metro-M.svg" class="blue" alt="metro" width="25"/><img src="www/Metro-M-white.svg" class="white" alt="metro" width="25"/> Métro


</br>

<div style = "width: 100%; text-align: center;">
<span class="dot-red"></span> Interrompu
<span class="dot-orange"></span> Perturbé
</div>


```{r grid-metro}
fluidRow(
  column(
    width = 4,
    tags$img(src="www/Paris_m_1_jms.svg", alt="line_1", width="25", tags$b("Ligne 1")),
    make_chart(data = m_incidents, line = 1)
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_m_2_jms.svg", alt="line_2", width="25", tags$b("Ligne 2")),
    make_chart(data = m_incidents, line = 2)
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_m_3_jms.svg", alt="line_3", width="25", tags$b("Ligne 3")),
    make_chart(data = m_incidents, line = 3)
  )
)
fluidRow(
  column(
    width = 4,
    tags$img(src="www/Paris_m_4_jms.svg", alt="line_4", width="25", tags$b("Ligne 4")),
    make_chart(data = m_incidents, line = 4)
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_m_5_jms.svg", alt="line_5", width="25", tags$b("Ligne 5")),
    make_chart(data = m_incidents, line = 5)
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_m_6_jms.svg", alt="line_6", width="25", tags$b("Ligne 6")),
    make_chart(data = m_incidents, line = 6)
  )
)
fluidRow(
  column(
    width = 4,
    tags$img(src="www/Paris_m_7_jms.svg", alt="line_7", width="25", tags$b("Ligne 7")),
    make_chart(data = m_incidents, line = 7)
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_m_8_jms.svg", alt="line_8", width="25", tags$b("Ligne 8")),
    make_chart(data = m_incidents, line = 8)
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_m_9_jms.svg", alt="line_9", width="25", tags$b("Ligne 9")),
    make_chart(data = m_incidents, line = 9)
  )
)
fluidRow(
  column(
    width = 4,
    tags$img(src="www/Paris_m_10_jms.svg", alt="line_10", width="25", tags$b("Ligne 10")),
    make_chart(data = m_incidents, line = 10)
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_m_11_jms.svg", alt="line_11", width="25", tags$b("Ligne 11")),
    make_chart(data = m_incidents, line = 11)
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_m_12_jms.svg", alt="line_12", width="25", tags$b("Ligne 12")),
    make_chart(data = m_incidents, line = 12)
  )
)
fluidRow(
  column(
    width = 4,
    tags$img(src="www/Paris_m_13_jms.svg", alt="line_13", width="25", tags$b("Ligne 13")),
    make_chart(data = m_incidents, line = 13)
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_m_14_jms.svg", alt="line_14", width="25", tags$b("Ligne 14")),
    make_chart(data = m_incidents, line = 14)
  )
)
```






### <img src="www/RER.svg" class="blue" alt="RER" width="25"/><img src="www/RER-white.svg" class="white" alt="metro" width="25"/> RER

<br>

<div style = "width: 100%; text-align: center;">
<span class="dot-red"></span> Interrompu
<span class="dot-orange"></span> Perturbé
</div>

```{r grid-rer}
fluidRow(
  column(
    width = 4,
    tags$img(src="www/Paris_RER_A_icon.svg", alt="rer_a", width="25", tags$b("RER A")),
    make_chart(data = r_incidents, line = "RER_A", type = "rer")
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_RER_B_icon.svg", alt="rer_b", width="25", tags$b("RER B")),
    make_chart(data = r_incidents, line = "RERB", type = "rer")
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_RER_C_icon.svg", alt="rer_c", width="25", tags$b("RER C")),
    make_chart(data = r_incidents, line = "RERC_SNCF", type = "rer")
  )
)
fluidRow(
  column(
    width = 4,
    tags$img(src="www/Paris_RER_D_icon.svg", alt="rer_d", width="25", tags$b("RER D")),
    make_chart(data = r_incidents, line = "RERD_SNCF", type = "rer")
  ),
  column(
    width = 4,
    tags$img(src="www/Paris_RER_E_icon.svg", alt="rer_e", width="25", tags$b("RER E")),
    make_chart(data = r_incidents, line = "RERE_SNCF", type = "rer")
  )
)
```



### <img src="www/Logo_train_transilien.svg" class="blue" alt="Transilien" width="25"/><img src="www/Logo_train_transilien-white.svg" class="white" alt="Transilien" width="25"/> Transilien

</br>

<div style = "width: 100%; text-align: center;">
<span class="dot-red"></span> Interrompu
<span class="dot-orange"></span> Perturbé
</div>

```{r grid-transilien}
fluidRow(
  column(
    width = 4,
    tags$img(src="www/Logo_Paris_Transilien_ligneJ.svg", alt="line_j", width="25", tags$b("Ligne J")),
    make_chart(data = t_incidents, line = "LIGNEJ_SNCF", type = "transilien")
  ),
  column(
    width = 4,
    tags$img(src="www/Logo_Paris_Transilien_ligneL.svg", alt="line_l", width="25", tags$b("Ligne L")),
    make_chart(data = t_incidents, line = "LIGNEL_sncf", type = "transilien")
  ),
  column(
    width = 4,
    tags$img(src="www/Logo_Paris_Transilien_ligneP.svg", alt="line_p", width="25", tags$b("Ligne P")),
    make_chart(data = t_incidents, line = "LIGNEP_SNCF", type = "transilien")
  )
)
fluidRow(
  column(
    width = 4,
    tags$img(src="www/Logo_Paris_Transilien_ligneH.svg", alt="line_h", width="25", tags$b("Ligne H")),
    make_chart(data = t_incidents, line = "LigneH_SNCF", type = "transilien")
  ),
  column(
    width = 4,
    tags$img(src="www/Logo_Paris_Transilien_ligneN.svg", alt="line_n", width="25"),
    tags$img(src="www/Logo_Paris_Transilien_ligneU.svg", alt="line_u", width="25", tags$b("*Lignes N et U")),
    make_chart(data = t_incidents, line = "lignesNetU_SNCF", type = "transilien")
  ),
  column(
    width = 4,
    tags$img(src="www/Logo_Paris_Transilien_ligneR.svg", alt="line_r", width="25", tags$b("Ligne R")),
    make_chart(data = t_incidents, line = "LIGNER_SNCF", type = "transilien")
  )
)
```



### Total

```{r total}

# chart helper
make_total_chart <- function(data, titre) {
  billboarder(data = data) %>% 
  bb_barchart(
    mapping = bbaes(x = lib, y = value, group = variable),
    stacked = TRUE, rotated = TRUE
  ) %>% 
  bb_data(
    order = "desc",
    groups = list(as.list(c("perturbe", "interrompu"))),
    names = list("perturbe" = "Perturbé", "interrompu" = "Interrompu")
  ) %>% 
  bb_colors_manual(interrompu = "#FA5858", perturbe = "#F7D358") %>% 
  bb_y_grid(show = TRUE) %>% 
  bb_y_axis(max = 900) %>% 
  bb_legend(usePoint = TRUE) %>% 
  bb_labs(
    title = titre,
    y = "Nombre de tweets"
  ) %>% 
  bb_add_style(".bb-tooltip th" = "background-color: #337ab7;")
}


# Prep data
# Metro
m_incidents_tot <- m_incidents[, list(value = sum(value)), by = list(screen_name, variable)]
m_incidents_tot[, lib := str_remove(string = screen_name, pattern = "_RATP")]
m_incidents_tot[, lib := str_replace(string = lib, pattern = "(\\d{1,2})", replacement = " \\1")]


# RER
r_incidents_tot <- r_incidents[, list(value = sum(value)), by = list(screen_name, variable)]
libs <- c(
  "RER A" = "RER_A",
  "RER B" = "RERB", 
  "RER C" = "RERC_SNCF",
  "RER D" = "RERD_SNCF", 
  "RER E" = "RERE_SNCF"
)
r_incidents_tot[, lib := names(libs)[chmatch(x = screen_name, table = libs)]]
setorder(r_incidents_tot, lib, variable)

# Transilien
t_incidents_tot <- t_incidents[, list(value = sum(value)), by = list(screen_name, variable)]
libs <- c(
  "Ligne J" = "LIGNEJ_SNCF",
  "Ligne L" = "LIGNEL_sncf", 
  "Ligne P" = "LIGNEP_SNCF",
  "Ligne R" = "LIGNER_SNCF", 
  "Ligne H" = "LigneH_SNCF", 
  "Lignes N\net U" = "lignesNetU_SNCF"
)
t_incidents_tot[, lib := names(libs)[chmatch(x = screen_name, table = libs)]]
setorder(t_incidents_tot, lib, variable)



fluidRow(
  column(
    width = 8, offset = 2,
    make_total_chart(m_incidents_tot, "Total lignes de métro"),
    make_total_chart(r_incidents_tot, "Total lignes de RER"),
    make_total_chart(t_incidents_tot, "Total lignes de Transilien")
  )
)

```








